<script>
    let KEYS = { groq: "", hf: [], currentHF: 0 };
    const zip = new JSZip();
    let csvData = "image_name,caption\n";

    async function startBatch() {
        document.getElementById('run-btn').disabled = true;
        log("Initiating USA Fashion Trend Scouting...", "#fff");
        
        try {
            const trendsRaw = await groqCall("List 5 high-end street fashion trends in USA for 2026. Names only, separated by commas.");
            
            // Safety Check: Agar Groq response khali ho
            if(!trendsRaw || trendsRaw.includes("error")) {
                throw new Error("Groq API didn't return trends. Check your Key.");
            }

            const trends = trendsRaw.split(',').map(t => t.trim()).filter(t => t.length > 0);
            log(`Found ${trends.length} Trends. Starting Production...`, "#00ff88");
            
            let total = 0;
            for (let trend of trends) {
                log(`Trend: ${trend.toUpperCase()}`, "#34d399");
                for (let i = 0; i < 5; i++) {
                    total++;
                    document.getElementById('count-display').innerText = `${total}/25`; // Reduced to 25 for first test
                    
                    const content = await groqCall(`Trend: ${trend}. Write: 1) Viral FB caption. 2) 1-sentence image prompt. Format: [C]caption[P]prompt`);
                    
                    if(!content.includes('[P]')) continue; // Skip if format is wrong

                    const parts = content.split('[P]');
                    const caption = parts[0].replace('[C]', '').trim();
                    const prompt = parts[1] || trend;

                    const imgBlob = await fluxCall(prompt);
                    const fileName = `post_${total}.jpg`;
                    zip.file(fileName, imgBlob);
                    csvData += `"${fileName}","${caption.replace(/"/g, '""')}"\n`;
                    
                    log(`Post ${total} Done.`, "#888");
                    await new Promise(r => setTimeout(r, 1000)); // 1 sec gap to avoid rate limit
                }
            }

            log("Finalizing ZIP...", "#fff");
            zip.file("meta_upload.csv", csvData);
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "ChicDaily_Batch.zip";
            a.click();
            log("âœ… BATCH DOWNLOADED SUCCESSFULLY!", "#00ff88");

        } catch (e) { 
            log("CRITICAL ERROR: " + e.message, "#ff4444");
            console.error(e);
        }
        document.getElementById('run-btn').disabled = false;
    }

    // Is groqCall function mein maine error check daal dia hai
    async function groqCall(prompt) {
        try {
            const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${KEYS.groq}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: "llama-3.1-70b-versatile", messages: [{role: "user", content: prompt}] })
            });
            const d = await r.json();
            if(d.error) return "error: " + d.error.message;
            return d.choices[0].message.content;
        } catch (err) { return "error: connection failed"; }
    }
    // ... (Keep fluxCall same as before) ...
</script>
