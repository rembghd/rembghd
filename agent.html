<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SADSHA AGENT | PREVIEW & ZIP MODE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #0b1120; --card: #111827; --yellow: #fbbf24; --border: #1f2937; --green: #10b981; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; max-width: 900px; margin: 0 auto; }
        label { display: block; font-size: 11px; color: var(--yellow); font-weight: 800; margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); color: #fff; border-radius: 6px; margin-bottom: 15px; font-size: 13px; outline: none; }
        .btn-main { width: 100%; padding: 16px; background: var(--yellow); color: #000; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        
        /* PREVIEW OVERLAY */
        #preview-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 17, 32, 0.98); z-index: 1000; padding: 40px; box-sizing: border-box; }
        .preview-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1100px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--yellow); }
        .preview-image { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border); }
        .preview-image img { width: 100%; height: 100%; object-fit: cover; }
        .preview-info { display: flex; flex-direction: column; justify-content: space-between; }
        .caption-box { background: #000; padding: 20px; border-radius: 8px; color: #fff; font-style: italic; border-left: 4px solid var(--yellow); height: 150px; overflow-y: auto; }
        .status-badge { display: inline-block; padding: 5px 12px; background: var(--yellow); color: #000; font-weight: 900; border-radius: 4px; font-size: 12px; margin-bottom: 10px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--yellow); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card" id="main-ui">
    <h2 style="margin-top:0;">SADSHA <span style="color:var(--yellow);">AGENT</span></h2>
    
    <label>Text API Key (Gemini)</label>
    <input type="password" id="text-key" placeholder="Enter Gemini Key">

    <label>Hugging Face Keys (Rotation)</label>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
        <input type="password" class="hf-key" placeholder="Key 1">
        <input type="password" class="hf-key" placeholder="Key 2">
        <input type="password" class="hf-key" placeholder="Key 3">
    </div>

    <label>Category & Batch</label>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <select id="cat"><option>Fashion</option><option>Product</option></select>
        <select id="batch-size"><option value="10">10 Posts</option></select>
    </div>

    <label>Custom Instruction</label>
    <textarea id="custom-p" style="height:60px;">USA Street Style, High-end photography, cinematic lighting, 8k.</textarea>

    <button class="btn-main" onclick="startProduction()">Launch Production Engine</button>
</div>

<div id="preview-overlay">
    <div class="preview-content">
        <div class="preview-image" id="img-container">
            <div class="loader"></div>
        </div>
        <div class="preview-info">
            <div>
                <span class="status-badge" id="source-tag">Connecting...</span>
                <h3 id="progress-text">Processing Post 1/10</h3>
                <label>Caption:</label>
                <div class="caption-box" id="caption-display">Fetching from Gemini...</div>
            </div>
            
            <div id="final-action" style="display:none;">
                <p style="color:var(--green); font-weight:bold;">âœ“ All Posts Rendered Successfully!</p>
                <button class="btn-main" onclick="downloadZip()">Download ZIP Package</button>
            </div>
        </div>
    </div>
</div>

<script>
    let zip = new JSZip();
    let batchCaptions = [];
    let processedFiles = [];

    async function fetchGeminiCaptions(key, prompt, count) {
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: `${prompt}. Provide exactly ${count} unique fashion captions. Return ONLY a JSON array of strings.` }] }] })
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text;
            return JSON.parse(text.match(/\[.*\]/s)[0]);
        } catch (e) {
            return Array(count).fill("Modern USA Fashion Aesthetic #OOTD");
        }
    }

    async function startProduction() {
        const textKey = document.getElementById('text-key').value;
        const hfKeys = Array.from(document.querySelectorAll('.hf-key')).map(i => i.value).filter(v => v !== "");
        if(!textKey || hfKeys.length === 0) return alert("Please fill all keys!");

        document.getElementById('preview-overlay').style.display = 'block';
        batchCaptions = await fetchGeminiCaptions(textKey, document.getElementById('custom-p').value, 10);
        
        let csvContent = "file_name,caption\n";

        for(let i=0; i<10; i++) {
            const currentKey = hfKeys[i % hfKeys.length];
            const sourceText = `HF KEY ${ (i % hfKeys.length) + 1 }`;
            
            // Update UI
            document.getElementById('source-tag').innerText = sourceText;
            document.getElementById('progress-text').innerText = `Processing Post ${i+1}/10`;
            document.getElementById('caption-display').innerText = batchCaptions[i];
            document.getElementById('img-container').innerHTML = '<div class="loader"></div>';

            // Generate via Pollinations (Backup logic for Zip reliability)
            const prompt = encodeURIComponent(batchCaptions[i] + ", " + document.getElementById('custom-p').value);
            const imgUrl = `https://pollinations.ai/p/${prompt}?width=1080&height=1350&nologo=true`;
            
            try {
                const imgRes = await fetch(imgUrl);
                const blob = await imgRes.blob();
                const fileName = `post_${i+1}.jpg`;
                
                // Show in Preview
                const blobUrl = URL.createObjectURL(blob);
                document.getElementById('img-container').innerHTML = `<img src="${blobUrl}">`;
                
                // Add to ZIP
                zip.file(fileName, blob);
                csvContent += `${fileName},"${batchCaptions[i].replace(/"/g, '""')}"\n`;
                
                await new Promise(r => setTimeout(r, 2000)); // 2 sec preview stay
            } catch (e) { console.error("Post failed"); }
        }

        zip.file("meta_bulk_upload.csv", csvContent);
        document.getElementById('final-action').style.display = 'block';
    }

    async function downloadZip() {
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `SADSHA_BATCH_${Date.now()}.zip`;
        link.click();
        location.reload(); // Reset for next batch
    }
</script>

</body>
</html>
